// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// public/js/app.js
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 0) Ø«ÙˆØ§Ø¨Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
const API_BASE       = 'https://dwam-app-by-omar.onrender.com/api';
const LOGIN_ENDPOINT = `${API_BASE}/login`;
const NOTIFS_ENDPOINT= `${API_BASE}/notifications`;
const STORAGE_KEY    = 'notificationsLog';
const SUPERVISOR_CODE= '35190';

let jwtToken    = null;
let currentUser = null;

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// Helper: ØªØ·Ø¨ÙŠØ¹ Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ© â†’ ØºØ±Ø¨ÙŠØ©
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function normalizeDigits(str) {
  return str.replace(/[Ù -Ù©]/g, d => 'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'.indexOf(d));
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠØ© + Ø§Ù„Ø¹Ø±Ø¶
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function loadNotificationsLocal() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  } catch {
    return [];
  }
}
function saveNotificationsLocal(arr) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}
function updateBellCount() {
  const cnt = loadNotificationsLocal().length;
  const el  = document.getElementById('notifCount');
  if (!el) return;
  el.textContent = cnt;
  el.style.display = cnt > 0 ? 'inline-block' : 'none';
}
function renderNotifications() {
  const list = document.getElementById('notificationsLog');
  const clearBtn = document.getElementById('clearNotifications');
  const nots = loadNotificationsLocal();
  if (!list || !clearBtn) return;

  list.innerHTML = '';
  if (nots.length === 0) {
    list.innerHTML = '<li class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</li>';
    clearBtn.classList.add('hidden');
  } else {
    nots.forEach(n => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${n.title}</strong><br>${n.body}<br><small>${n.time}</small>`;
      li.className = 'mb-2 border-b pb-1';
      list.appendChild(li);
    });
    // Ø²Ø± Ù…Ø³Ø­ Ù„Ù„Ù…Ø´Ø±Ù ÙÙ‚Ø·
    if (currentUser === SUPERVISOR_CODE) {
      clearBtn.classList.remove('hidden');
    } else {
      clearBtn.classList.add('hidden');
    }
  }
}
function clearNotifications() {
  if (currentUser !== SUPERVISOR_CODE) return alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©');
  if (!confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ')) return;
  localStorage.removeItem(STORAGE_KEY);
  renderNotifications();
  updateBellCount();
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… ÙˆØ­ÙØ¸Ù‡Ø§ Ù…Ø­Ù„ÙŠÙ‹Ø§
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
window.loadNotificationsFromServer = async function() {
  try {
    const res = await fetch(NOTIFS_ENDPOINT, {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${jwtToken}`
      }
    });
    if (!res.ok) throw new Error(`Status ${res.status}`);
    const { data } = await res.json();
    saveNotificationsLocal(data);
    renderNotifications();
    updateBellCount();
  } catch (e) {
    console.warn('âŒ Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…:', e);
  }
};

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// Ø¯Ø§Ù„Ø© addNotification ØªÙØ³ØªØ®Ø¯Ù… Ù…Ù† push.js Ùˆ SW
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
window.addNotification = function({ title, body, time }) {
  const arr = loadNotificationsLocal();
  arr.unshift({ title, body, time });
  if (arr.length > 50) arr.pop();
  saveNotificationsLocal(arr);
  renderNotifications();
  updateBellCount();
};

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// DOMContentLoaded: Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginBtn').onclick  = login;
  document.getElementById('logoutBtn').onclick = logout;
  document.getElementById('aboutBtn').onclick  = () =>
    alert('ÙÙƒØ±Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯ ÙˆØªØµÙ…ÙŠÙ… Ø¹Ù…Ø± Ø¹ÙˆÙ†Ù€ÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚');
  document.getElementById('hwafezBtn').onclick = showHwafez;
  document.getElementById('tqeemBtn').onclick  = showTqeem;
  document.getElementById('clearNotifications').onclick = clearNotifications;

  const savedToken = localStorage.getItem('jwtToken');
  if (savedToken) {
    jwtToken = savedToken;
    // 1) Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    fetchAndRender()
      .then(async () => {
        // 2) ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (SW + FCM)
        if (typeof window.initNotifications === 'function') {
          await window.initNotifications();
        }
        // 3) Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        await window.loadNotificationsFromServer();
      })
      .catch(logout);
  }
});

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
async function login() {
  const code = normalizeDigits(document.getElementById('codeInput').value.trim());
  const pass = document.getElementById('passwordInput').value.trim();
  if (!code || !pass) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');

  try {
    // 1) Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const res = await fetch(LOGIN_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, pass })
    });
    if (res.status === 401) return alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø®Ø§Ø·Ø¦Ø©');
    if (!res.ok) throw new Error(`Status ${res.status}`);

    // 2) Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
    const json = await res.json();
    jwtToken = json.token;
    localStorage.setItem('jwtToken', jwtToken);

    // 3) currentUser ÙˆØªØ®Ø²ÙŠÙ†Ù‡
    currentUser = json.user.code ?? json.user['ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù'];
    window.currentUser = currentUser;
    if (typeof window.initPush === 'function') {
  await window.initPush();
}
    console.log('âœ… login successful, user =', currentUser);

    // â†“ Ù‡Ù†Ø§ Ù†Ø¶ÙŠÙ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± â†“
    try {
      const notifRes = await fetch(`${API_BASE}/notifications/${currentUser}`, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${jwtToken}`
        }
      });
      if (notifRes.ok) {
        const serverNotifs = await notifRes.json();
        // Ø®Ø²Ù†Ù‡Ø§ ÙÙŠ localStorage Ù„ÙƒÙŠ ØªÙƒÙˆÙ† Ù…ÙˆØ­Ø¯Ø©
        localStorage.setItem('notificationsLog', JSON.stringify(serverNotifs));
        // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù„ÙˆØ­Ø© ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯
        if (typeof window.renderNotifications === 'function') {
          window.renderNotifications();
        }
        if (typeof window.updateBellCount === 'function') {
          window.updateBellCount();
        }
      } else {
        console.warn('Failed to fetch server notifications:', notifRes.status);
      }
    } catch (e) {
      console.warn('Error fetching server notifications:', e);
    }

    // 4) Ø«Ø¨Ù‘Øª Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    if (typeof window.initNotifications === 'function') {
      await window.initNotifications();
    }

    // 5) Ø«Ø¨Ù‘Øª Ø§Ù„Ù€ push (ÙˆÙŠØ¨ + Native)
    console.log('ğŸš€ calling initPush()â€¦');
    if (window.Capacitor && Capacitor.getPlatform() !== 'web') {
      await initPushNative();
    } else {
      await initPush();
    }

    // 6) ÙˆØ£Ø®ÙŠØ±Ø§Ù‹: Ø¬Ù„Ø¨ Ø¨Ø§Ù‚ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    await fetchAndRender();

  } catch (e) {
    console.error('âŒ login error:', e);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + e.message);
  }
}


// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 3) Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (attendance + hwafez + me)
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
async function fetchAndRender() {
  if (!jwtToken) return;

  const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${jwtToken}`
  };
  const [aRes, hwRes, meRes] = await Promise.all([
    fetch(`${API_BASE}/attendance`, { headers }),
    fetch(`${API_BASE}/hwafez`,      { headers }),
    fetch(`${API_BASE}/me`,          { headers })
  ]);
  if (!aRes.ok || !hwRes.ok || !meRes.ok) throw new Error('Unauthorized');

  const aJson  = await aRes.json();
  const hwJson = await hwRes.json();
  const meJson = await meRes.json();

  headersAtt     = aJson.headers;     attendanceData = aJson.data;
  headersHw      = hwJson.headers;    hwafezData     = hwJson.data;
  currentUser    = meJson.user['ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù'];

  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  document.getElementById('loginSection').classList.add('hidden');
  document.getElementById('records').classList.remove('hidden');
  document.getElementById('welcomeMsg').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser}`;

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø´Ø±Ù
  if (currentUser === SUPERVISOR_CODE) {
    document.getElementById('pushSection').classList.remove('hidden');
    document.getElementById('sendPushBtn').onclick = sendSupervisorNotification;
  }

  // Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ø´Ø±Ù
  const notesArea = document.getElementById('supervisorNotes');
  const saveBtn   = document.getElementById('saveNotesBtn');
  notesArea.value = localStorage.getItem('supervisorNotes') || '';
  if (currentUser === SUPERVISOR_CODE) {
    notesArea.removeAttribute('readonly');
    saveBtn.classList.remove('hidden');
    saveBtn.onclick = () => {
      localStorage.setItem('supervisorNotes', notesArea.value);
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©');
    };
  } else {
    notesArea.setAttribute('readonly', '');
    saveBtn.classList.add('hidden');
  }

  renderRecords();
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 4) Ø±Ø³Ù… Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function renderRecords() {
  const idx = {
    code:     headersAtt.indexOf('Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù'),
    name:     headersAtt.indexOf('Ø§Ù„Ø§Ø³Ù…'),
    status:   headersAtt.indexOf('Ø§Ù„Ø­Ø§Ù„Ø©'),
    date:     headersAtt.indexOf('Ø§Ù„ØªØ§Ø±ÙŠØ®'),
    in:       headersAtt.indexOf('Ø¯Ø®ÙˆÙ„'),
    out:      headersAtt.indexOf('Ø®Ø±ÙˆØ¬'),
    sFrom:    headersAtt.indexOf('Ø³Ø§Ø¹ÙŠØ© (Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø©)'),
    sTo:      headersAtt.indexOf('Ø³Ø§Ø¹ÙŠØ© (Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø©)'),
    mFrom:    headersAtt.indexOf('Ù…Ù‡Ù…Ø© (Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø©)'),
    mTo:      headersAtt.indexOf('Ù…Ù‡Ù…Ø© (Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø©)'),
    days:     headersAtt.indexOf('Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø­ØªØ³Ø¨Ø© Ø¨ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³Ø§Ø¹ÙŠØ§Øª Ø£Ùˆ Ø§Ù„ØªØ£Ø®Ø± Ø£Ù‚Ù„ Ù…Ù† Ø³Ø§Ø¹Ø©'),
    notes:    headersAtt.indexOf('Ù…Ù„Ø§Ø­Ø¸Ø§Øª'),
    adminC:   headersAtt.indexOf('Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø­ØªØ³Ø¨Ø© Ù„Ù„Ø¹Ø§Ù…Ù„'),
    adminR:   headersAtt.indexOf('Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ù„Ù„Ø¹Ø§Ù…Ù„'),
    adminDue: headersAtt.indexOf('Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© Ù„Ù„Ø¹Ø§Ù…Ù„'),
  };

  const rows = attendanceData.filter(r =>
    String(r[idx.code]).trim() === currentUser
  );
  const tbody = document.getElementById('attendanceBody');
  tbody.innerHTML = '';

  if (!rows.length) {
    document.getElementById('noDataMsg').classList.remove('hidden');
    return;
  }
  document.getElementById('noDataMsg').classList.add('hidden');

  // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  const first = rows[0];
  document.getElementById('adminLeavesDue').textContent       = first[idx.adminDue]  || '--';
  document.getElementById('adminLeavesCounted').textContent   = first[idx.adminC]    || '--';
  document.getElementById('adminLeavesRemaining').textContent = first[idx.adminR]    || '--';

  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="border px-4 py-2">${r[idx.code]||''}</td>
      <td class="border px-4 py-2">${r[idx.name]||''}</td>
      <td class="border px-4 py-2">${caseMapping[String(r[idx.status]).trim()]||''}</td>
      <td class="border px-4 py-2">${r[idx.date]||''}</td>
      <td class="border px-4 py-2">${r[idx.in]||''}</td>
      <td class="border px-4 py-2">${r[idx.out]||''}</td>
      <td class="border px-4 py-2">${r[idx.sFrom]||''}</td>
      <td class="border px-4 py-2">${r[idx.sTo]||''}</td>
      <td class="border px-4 py-2">${r[idx.mFrom]||''}</td>
      <td class="border px-4 py-2">${r[idx.mTo]||''}</td>
      <td class="border px-4 py-2">${r[idx.days]||''}</td>
      <td class="border px-4 py-2">${r[idx.notes]||''}</td>
    `;
    tbody.appendChild(tr);
  });
}


// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 5) Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙˆØ§ÙØ²
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
async function showHwafez() {
  try {
    const res = await fetch(`${API_BASE}/hwafez`, {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${jwtToken}`
      }
    });
    if (!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙˆØ§ÙØ²');
    const { headers, data } = await res.json();
    headersHw  = headers;
    hwafezData = data;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… ÙˆØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„
    document.getElementById('hwafezSection').classList.remove('hidden');
    const tbody = document.getElementById('hwafezBody');
    tbody.innerHTML = '';

    // Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
    if (data.length === 0) {
      document.getElementById('noHwafezMsg').classList.remove('hidden');
      return;
    }
    document.getElementById('noHwafezMsg').classList.add('hidden');

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ
    data.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border px-4 py-2">${r[headers.indexOf('Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ø§Ø³Ù…')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§ØªÙ‚Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ ÙˆÙØ¹Ø§Ù„ÙŠØªÙ‡')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯ÙŠØ©')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ù…Ù‡Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ø¥Ø³ØªÙ‚Ù„Ø§Ù„ ÙˆØ§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ø¥Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙˆØ§Ù… Ø§Ù„ÙØ¹Ù„ÙŠ')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ø³ÙˆÙŠÙ‘Ø© Ø§Ù„ÙˆØ¸ÙŠÙÙŠÙ‘Ø©')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ£Ù‡ÙŠÙ„')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©')] || ''}</td>
      `;
      tbody.appendChild(tr);
    });

    // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ù‚Ø³Ù…
    document.getElementById('hwafezSection')
            .scrollIntoView({ behavior: 'smooth' });

  } catch (e) {
    console.error('âŒ showHwafez error:', e);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙˆØ§ÙØ²');
  }
}  // â† ØºÙ„Ù‚ showHwafez()

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 5.1) Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ù†ÙˆÙŠ
async function showTqeem() {
  try {
    const res = await fetch(`${API_BASE}/tqeem`, {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${jwtToken}`
      }
    });
    if (!res.ok) {
      throw new Error(`ÙØ´Ù„ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ù†ÙˆÙŠ (status: ${res.status})`);
    }
    const {
      headers,
      data
    } = await res.json();
    headersTq = headers;
    tqeemData = data;
    const section = document.getElementById('tqeemSection');
    section.classList.remove('hidden');
    const tbody = document.getElementById('tqeemBody');
    tbody.innerHTML = '';
    const noMsg = document.getElementById('noTqeemMsg');
    if (data.length === 0) {
      noMsg.classList.remove('hidden');
      section.scrollIntoView({
        behavior: 'smooth'
      });
      return;
    }
    noMsg.classList.add('hidden');
    data.forEach(r => {
      const tr = document.createElement('tr');
      tr.className = 'divide-y divide-gray-100';
      tr.innerHTML = `
        <td class="border px-4 py-2">${r[headers.indexOf('Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ø§Ø³Ù…')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø­Ø¬Ù… Ø§Ù„Ø¹Ù…Ù„')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§ØªÙ‚Ø§Ù† Ø§Ù„Ø¹Ù…Ù„ ÙˆÙØ¹Ø§Ù„ÙŠØªÙ‡')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯ÙŠØ©')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ù…Ù‡Ø§Ø±Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ØªÙŠØ©')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© ÙˆØ§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠ')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ø§Ø³ØªÙ‚Ù„Ø§Ù„ ÙˆØ§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠØ©')] || ''}</td>
        <td class="border px-4 py-2">${r[headers.indexOf('Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©')] || ''}</td>
      `;
      tbody.appendChild(tr);
    });
    section.scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  } catch (e) {
    console.error('âŒ showTqeem error:', e);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ù†ÙˆÙŠ');
  }
}
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 6) Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø´Ø±Ù
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
async function sendSupervisorNotification() {
  try {
    const title = document.getElementById('notifTitleInput').value.trim();
    const body  = document.getElementById('notifBodyInput').value.trim();
    if (!title || !body) {
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† ÙˆÙ†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±.');
      return;
    }
    const res = await fetch(`${API_BASE}/notify-all`, {
      method: 'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization': `Bearer ${jwtToken}`
      },
      body: JSON.stringify({ title, body })
    });
    if (!res.ok) throw new Error(await res.text());
    alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.');
    document.getElementById('notifTitleInput').value = '';
    document.getElementById('notifBodyInput').value  = '';
  } catch (err) {
    console.error('âŒ sendSupervisorNotification error:', err);
    alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ' + err.message);
  }
}

// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
// 7) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
// â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
function logout() {
  currentUser = null;
  jwtToken     = null;
  localStorage.removeItem('jwtToken');
  ['records','pushSection','hwafezSection'].forEach(id =>
    document.getElementById(id).classList.add('hidden')
  );
  document.getElementById('loginSection').classList.remove('hidden');
}
