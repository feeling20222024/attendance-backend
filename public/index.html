// —————————————————————————————————————————
// 1) إعداد Firebase (قيمك كما في SW)
firebase.initializeApp({
  apiKey:    "AIzaSyClFXniBltSeJrp3sxS3_bAgbrZPo0vP3Y",
  authDomain:"device-streaming-47cbe934.firebaseapp.com",
  projectId: "device-streaming-47cbe934",
  storageBucket:"device-streaming-47cbe934.appspot.com",
  messagingSenderId:"235398312189",
  appId:     "1:235398312189:web:8febe5e63f7b134b808e94"
});

// —————————————————————————————————————————
// 2) المتغيرات والنهايات
const API_BASE       = 'https://dwam-app-by-omar.onrender.com/api';
const LOGIN_ENDPOINT = `${API_BASE}/login`;
const SUPERVISOR_CODE= '35190';

let jwtToken   = null;
let currentUser= null;

// ماب للحالات
const caseMapping = {
  '1': "غياب غير مبرر (بدون إذن رسمي)",
  '2': "تأخر أكثر من ساعة أو عدم مهر البصمة صباحاً",
  '3': "خروج مبكر (أو عدم مهر البصمة مساءً)",
  '4': "عدد مرات التأخر أقل من ساعة (حسم يوم كل 3 تأخيرات)",
  '5': "تجميع ساعيات (كل ثماني ساعات يتم احتساب يوم)"
};

// Helper: تطبيع أرقام عربية → غربية
function normalizeDigits(str) {
  return str.replace(/[٠-٩]/g, d => '٠١٢٣٤٥٦٧٨٩'.indexOf(d));
}

// —————————————————————————————————————————
// 3) initPush: تهيئة إشعارات الويب عبر FCM+SW
// —————————————————————————————————————————
window.initPush = async () => {
  if (!('serviceWorker' in navigator) || !firebase.messaging) return;
  const reg = await navigator.serviceWorker.register('/firebase-messaging-sw.js', { scope: '/' });
  console.log('✅ Firebase SW registered:', reg.scope);

  const messaging = firebase.messaging();
  const permission = await Notification.requestPermission();
  if (permission !== 'granted') {
    console.warn('❌ إشعارات الويب مرفوضة');
    return;
  }
  const token = await messaging.getToken({
    vapidKey: "BIvZq29UIB5CgKiIXUOCVVVDX0DtyKuixDyXm6WpCc1f18go2a6oWWw0VrMBYPLSxco2-44GyDVH0U5BHn7ktiQ",
    serviceWorkerRegistration: reg
  });
  console.log('✅ FCM token (web):', token);

  // سجل التوكن في الخادم
  await fetch(`${API_BASE}/register-token`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ user: currentUser, token })
  });
  console.log('✅ تم تسجيل التوكن على الخادم');

  // استمع للرسائل في الواجهة
  messaging.onMessage(payload => {
    const { title, body } = payload.notification || {};
    if (title) new Notification(title, { body });
  });
};

// —————————————————————————————————————————
// 4) loginWeb: عملية تسجيل الدخول في الويب
// —————————————————————————————————————————
async function loginWeb() {
  const code = normalizeDigits(document.getElementById('codeInput').value.trim());
  const pass = document.getElementById('passwordInput').value.trim();
  if (!code || !pass) {
    return alert('يرجى إدخال الكود وكلمة المرور.');
  }

  const res = await fetch(LOGIN_ENDPOINT, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ code, pass })
  });
  if (res.status === 401) {
    return alert('بيانات الدخول خاطئة');
  }
  if (!res.ok) {
    throw new Error(`خطأ بالخادم (${res.status})`);
  }

  const { token, user } = await res.json();
  jwtToken = token;
  localStorage.setItem('jwtToken', token);

  currentUser = user.code ?? user['كود الموظف'];
  window.currentUser = currentUser;
  console.log('✅ loginWeb:', currentUser);

  // تهيئة إشعارات الويب
  await window.initPush();

  // جلب وعرض البيانات
  await fetchAndRenderWeb();
}

// —————————————————————————————————————————
// 5) fetchAndRenderWeb: جلب البيانات وعرضها في الويب
// —————————————————————————————————————————
async function fetchAndRenderWeb() {
  if (!jwtToken) return;
  const headers = {
    'Content-Type':'application/json',
    'Authorization': `Bearer ${jwtToken}`
  };
  const [aRes, hwRes, meRes] = await Promise.all([
    fetch(`${API_BASE}/attendance`, { headers }),
    fetch(`${API_BASE}/hwafez`,      { headers }),
    fetch(`${API_BASE}/me`,          { headers })
  ]);
  if (!aRes.ok || !hwRes.ok || !meRes.ok) {
    throw new Error('Unauthorized');
  }
  const aJson  = await aRes.json();
  const hwJson = await hwRes.json();
  const meJson = await meRes.json();

  renderAttendance(aJson.headers, aJson.data, meJson.user['كود الموظف']);
  renderHwafez   (hwJson.headers, hwJson.data);
}

// —————————————————————————————————————————
// 6) renderAttendance: عرض جدول الحضور في الويب
// —————————————————————————————————————————
function renderAttendance(headers, data, userCode) {
  // إظهار الواجهة
  document.getElementById('loginSection').hidden = true;
  document.getElementById('records').hidden      = false;
  document.getElementById('welcomeMsg').textContent = `مرحباً ${userCode}`;

  // مشرف؟ نظهر قسم الإشعارات
  if (String(userCode) === SUPERVISOR_CODE) {
    document.getElementById('pushSection').hidden = false;
    document.getElementById('sendPushBtn').onclick = async () => {
      const t = document.getElementById('notifTitleInput').value.trim();
      const b = document.getElementById('notifBodyInput').value.trim();
      if (!t||!b) return alert('يرجى عنوان ونص الإشعار');
      const r = await fetch(`${API_BASE}/notify-all`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${jwtToken}` },
        body: JSON.stringify({ title:t, body:b })
      });
      r.ok ? alert('✅ تم الإرسال') : alert('❌ فشل الإرسال');
    };
  } else {
    document.getElementById('pushSection').hidden = true;
  }

  // تعاريف الأعمدة
  const idx = {
    code:    headers.indexOf('رقم الموظف'),
    name:    headers.indexOf('الاسم'),
    status:  headers.indexOf('الحالة'),
    date:    headers.indexOf('التاريخ'),
    in:      headers.indexOf('دخول'),
    out:     headers.indexOf('خروج'),
    sFrom:   headers.indexOf('ساعية (من الساعة)'),
    sTo:     headers.indexOf('ساعية (إلى الساعة)'),
    mFrom:   headers.indexOf('مهمة (من الساعة)'),
    mTo:     headers.indexOf('مهمة (إلى الساعة)'),
    days:    headers.indexOf('عدد الأيام المحتسبة بتقرير الساعيات أو التأخر أقل من ساعة'),
    notes:   headers.indexOf('ملاحظات'),
    adminC:  headers.indexOf('عدد الإجازات الإدارية المحتسبة للعامل'),
    adminR:  headers.indexOf('عدد الإجازات الإدارية المتبقية للعامل'),
    adminDue:headers.indexOf('عدد الإجازات الإدارية المستحقة للعامل')
  };

  const tbody = document.getElementById('attendanceBody');
  tbody.innerHTML = '';
  data.filter(r => String(r[idx.code]||'').trim() === String(userCode))
      .forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-4 py-2">${r[idx.code]||''}</td>
          <td class="border px-4 py-2">${r[idx.name]||''}</td>
          <td class="border px-4 py-2">${caseMapping[String(r[idx.status]).trim()]||''}</td>
          <td class="border px-4 py-2">${r[idx.date]||''}</td>
          <td class="border px-4 py-2">${r[idx.in]||''}</td>
          <td class="border px-4 py-2">${r[idx.out]||''}</td>
          <td class="border px-4 py-2">${r[idx.sFrom]||''}</td>
          <td class="border px-4 py-2">${r[idx.sTo]||''}</td>
          <td class="border px-4 py-2">${r[idx.mFrom]||''}</td>
          <td class="border px-4 py-2">${r[idx.mTo]||''}</td>
          <td class="border px-4 py-2">${r[idx.days]||''}</td>
          <td class="border px-4 py-2">${r[idx.notes]||''}</td>
          <td class="border px-4 py-2">${r[idx.adminC]||''}</td>
          <td class="border px-4 py-2">${r[idx.adminR]||''}</td>
          <td class="border px-4 py-2">${r[idx.adminDue]||''}</td>
        `;
        tbody.appendChild(tr);
      });
}

// —————————————————————————————————————————
// 7) renderHwafez: عرض جدول الحوافز في الويب
// —————————————————————————————————————————
function renderHwafez(headers, data) {
  const idx = {
    code:         headers.indexOf('رقم الموظف'),
    name:         headers.indexOf('الاسم'),
    work:         headers.indexOf('حجم العمل'),
    mastery:      headers.indexOf('اتقان العمل وفعاليته'),
    leadership:   headers.indexOf('المهارات القيادية'),
    self:         headers.indexOf('مهارة الإدارة الذاتية'),
    comms:        headers.indexOf('مهارات التواصل والتفاعل'),
    initiative:   headers.indexOf('المبادرة والتطوير الذاتي'),
    independence: headers.indexOf('الإستقلال والموثوقية'),
    resp:         headers.indexOf('الإلتزام والمسؤولية'),
    pct:          headers.indexOf('نسبة الدوام الفعلي للعامل'),
    balance:      headers.indexOf('السويّة الوظيفيّة'),
    qual:         headers.indexOf('مستوى التأهيل'),
    exp:          headers.indexOf('سنوات الخبرة')
  };

  const tbody = document.getElementById('hwafezBody');
  tbody.innerHTML = '';
  data.filter(r => String(r[idx.code]||'').trim() === String(currentUser))
      .forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border px-4 py-2">${r[idx.code]||''}</td>
          <td class="border px-4 py-2">${r[idx.name]||''}</td>
          <td class="border px-4 py-2">${r[idx.work]||''}</td>
          <td class="border px-4 py-2">${r[idx.mastery]||''}</td>
          <td class="border px-4 py-2">${r[idx.leadership]||''}</td>
          <td class="border px-4 py-2">${r[idx.self]||''}</td>
          <td class="border px-4 py-2">${r[idx.comms]||''}</td>
          <td class="border px-4 py-2">${r[idx.initiative]||''}</td>
          <td class="border px-4 py-2">${r[idx.independence]||''}</td>
          <td class="border px-4 py-2">${r[idx.resp]||''}</td>
          <td class="border px-4 py-2">${r[idx.pct]||''}</td>
          <td class="border px-4 py-2">${r[idx.balance]||''}</td>
          <td class="border px-4 py-2">${r[idx.qual]||''}</td>
          <td class="border px-4 py-2">${r[idx.exp]||''}</td>
        `;
        tbody.appendChild(tr);
      });
}

// —————————————————————————————————————————
// 8) ربط الأزرار (ويب فقط)
// —————————————————————————————————————————
document.getElementById('loginBtn').onclick  = loginWeb;
document.getElementById('logoutBtn').onclick = () => {
  localStorage.removeItem('jwtToken');
  document.getElementById('records').hidden = true;
  document.getElementById('loginSection').hidden = false;
};
